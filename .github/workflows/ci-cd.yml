name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x]
        
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        components: rustfmt, clippy
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        pip install pylint pytest black
        
    - name: Install Go dependencies
      run: go mod tidy
      working-directory: ./compiler/checker
      
    - name: Install Rust dependencies
      run: cargo check
      working-directory: ./compiler/lexer
      
    - name: Run linters
      run: |
        npm run lint
        cargo clippy --manifest-path=compiler/lexer/Cargo.toml
        cargo clippy --manifest-path=compiler/analyzer/Cargo.toml
        go vet ./compiler/checker/...
        pylint compiler/transpiler/main.py
        
    - name: Run tests
      run: |
        npm test
        cargo test --manifest-path=compiler/lexer/Cargo.toml
        cargo test --manifest-path=compiler/analyzer/Cargo.toml
        go test ./compiler/checker/...
        python -m pytest tests/unit/transpiler/
        
  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build Rust modules
      run: |
        cd compiler/lexer && cargo build --release
        cd ../analyzer && cargo build --release
        
    - name: Build Go module
      run: |
        cd compiler/checker && go build -o checker main.go
        
    - name: Build TypeScript module
      run: |
        cd compiler/parser && npm run build
        
    - name: Verify Python module
      run: |
        python -m py_compile compiler/transpiler/main.py
        
    - name: Run full build
      run: node build.js build-all
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: compiled-binaries
        path: |
          compiler/lexer/target/release/lexer
          compiler/analyzer/target/release/analyzer
          compiler/checker/checker
          compiler/parser/dist/
          
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Security scan
      uses: github/super-linter@v4
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_ALL_CODEBASE: true
        VALIDATE_RUST: true
        VALIDATE_GO: true
        VALIDATE_PYTHON_BLACK: true
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_TYPESCRIPT_ES: true
        
  deploy-dev:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Deploy to development
      run: echo "Deploying to development environment..."
      # Add actual deployment steps here
      
  deploy-prod:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to production
      run: echo "Deploying to production environment..."
      # Add actual deployment steps here